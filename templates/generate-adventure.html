{% extends "layout.html" %}

{% block title %}
    Adventure Planner (AI)
{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}

{% block main %}
<div class="w-full max-w-lg p-8 bg-white rounded-2xl shadow-2xl border border-gray-100 mx-auto">
    
    <h1 class="text-3xl font-extrabold mb-4 text-center text-gray-800">
        AI Adventure Planner
    </h1>
    <p class="text-center text-gray-600 mb-6">
<<<<<<< HEAD
        Tell us where you want to go, and Gemini will suggest fictional adventures to take you there.
=======
        Tell us where you want to go, and AI will suggest fictional adventures to take you there.
>>>>>>> 0116a4d88aa52c60012489cff178d0215ba59a47
    </p>

    <form id="planner-form" class="space-y-4">
        <div class="mb-4">
            <label for="location-input" class="block text-sm font-medium text-gray-700 mb-1">
                Your Dream Destination (e.g., Venice, Tokyo, Mars):
            </label>
            <input type="text" id="location-input" required placeholder="Enter a city, region, or fictional world..."
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-blue-500 focus:border-blue-500">
        </div>

        <button type="submit" id="generate-button"
                class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 transform hover:scale-[1.01]">
            Suggest My Adventure
        </button>
    </form>

    <hr class="my-6 border-t border-gray-200">

    <div id="results-container" class="mt-6">
        <div id="loading-spinner" class="hidden text-center">
            <p class="text-blue-600 font-semibold mb-2">Planning your virtual journey...</p>
            <div class="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto"></div>
        </div>

        <div id="ai-output" class="hidden p-4 bg-gray-50 rounded-lg border border-gray-200"></div>
    </div>

</div>

<script>
const form = document.getElementById('planner-form');
const locationInput = document.getElementById('location-input');
const loadingSpinner = document.getElementById('loading-spinner');
const aiOutput = document.getElementById('ai-output');
const generateButton = document.getElementById('generate-button');

<<<<<<< HEAD
// --- GEMINI API SETUP ---
// The API key is injected by the Canvas environment if left empty.
const apiKey = ""; 
const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

// Utility function for exponential backoff during API calls (included for robustness)
async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                // If the error is NOT a 429 (rate limit), throw immediately
                if (response.status !== 429) {
                     // Attempt to get specific error message from the body
                    const errorBody = await response.json().catch(() => ({ error: 'Unknown API error' }));
                    throw new Error(`HTTP error! Status: ${response.status}. Detail: ${errorBody.error?.message || 'Server error.'}`);
                }
                
                // Handle 429 Rate Limit
                if (i === retries - 1) {
                    throw new Error(`Rate limit exceeded after ${retries} attempts.`);
                }
                
                console.warn('Rate limit hit. Retrying...');
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2; 
                continue;
            }
            return response;

        } catch (error) {
            if (i === retries - 1) throw error;
            console.error(`Fetch error (Attempt ${i + 1}):`, error.message);
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
        }
    }
}

=======
>>>>>>> 0116a4d88aa52c60012489cff178d0215ba59a47
async function generateAdventure(event) {
    event.preventDefault();
    const location = locationInput.value.trim();
    if (!location) return;

    aiOutput.classList.add('hidden');
    aiOutput.innerHTML = '';
    loadingSpinner.classList.remove('hidden');
    generateButton.disabled = true;
    generateButton.textContent = 'Suggesting...';

<<<<<<< HEAD
    // System Instruction guides the LLM's persona and output
    const systemPrompt = `You are a whimsical and knowledgeable Fiction Travel Agent. Your task is to suggest fictional media (books, movies, or TV series) that will let the user 'travel' to the user's requested location. Provide 3 distinct suggestions. For each suggestion, provide the Title, the Media Type, and a short, fun justification (1 sentence). Format your response strictly in Markdown using an unordered list.`;
    
    // User Query asks for the specific task
    const userQuery = `Suggest 3 fictional adventures for the destination: ${location}.`;

    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        
        // Use Google Search for grounding and up-to-date suggestions
        tools: [{ "google_search": {} }],

        systemInstruction: {
            parts: [{ text: systemPrompt }]
        },
    };

    const options = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    };

    try {
        if (typeof marked === 'undefined') {
             throw new Error("Marked.js library is not available. Cannot render Markdown.");
        }

        const response = await fetchWithBackoff(apiUrl, options);
        const result = await response.json();
        
        const candidate = result.candidates?.[0];

        if (candidate && candidate.content?.parts?.[0]?.text) {
            let generatedText = candidate.content.parts[0].text;
            
            // Render the Markdown output
            aiOutput.innerHTML = marked.parse(generatedText); 
            aiOutput.classList.remove('hidden');

        } else {
            // Handle case where API succeeds but returns no text (e.g., safety block)
            aiOutput.innerHTML = `<p class="text-red-600">Sorry, I couldn't find any adventures for that location or the response was blocked.</p>`;
=======
    try {
        const response = await fetch("/generate-adventure", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ location })
        });

        const result = await response.json();
        if (result.text) {
            aiOutput.innerHTML = marked.parse(result.text);
            aiOutput.classList.remove('hidden');
        } else {
            aiOutput.innerHTML = `<p class="text-red-600">${result.error}</p>`;
>>>>>>> 0116a4d88aa52c60012489cff178d0215ba59a47
            aiOutput.classList.remove('hidden');
        }

    } catch (error) {
<<<<<<< HEAD
        console.error("AI Generation Failed:", error);
        let userErrorMessage = "Error: Could not connect to the Adventure Planner. Check console for details (e.g., API key or network issues).";
        
        // Enhance user message if specific errors are known
        if (error.message.includes("400") || error.message.includes("401")) {
            userErrorMessage = "Error: Invalid API Key or Billing Issue. Please ensure your Gemini API is correctly set up.";
        }

        aiOutput.innerHTML = `<p class="text-red-600">${userErrorMessage}</p>`;
        aiOutput.classList.remove('hidden');

    } finally {
        // 3. Restore Button State
=======
        console.error(error);
        aiOutput.innerHTML = `<p class="text-red-600">Error: Could not generate adventures.</p>`;
        aiOutput.classList.remove('hidden');
    } finally {
>>>>>>> 0116a4d88aa52c60012489cff178d0215ba59a47
        loadingSpinner.classList.add('hidden');
        generateButton.disabled = false;
        generateButton.textContent = 'Suggest My Adventure';
    }
}

form.addEventListener('submit', generateAdventure);

</script>
{% endblock %}